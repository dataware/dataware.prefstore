<html>
<head>
<link rel="StyleSheet" href="extension.css" type="text/css">
<script type="text/javascript" src="jquery-1.6.min.js"></script>
<script>

	//-- Setup the constants that for the pages scripts
	DIV_NAMES = new Array();
	DIV_NAMES[ 0 ] = "loggedInBox";
	DIV_NAMES[ 1 ] = "loggedOutBox";
	DIV_NAMES[ 2 ] = "registerBox";
	DIV_NAMES[ 3 ] = "loggedOutMsg";
	PREFSTORE = window.localStorage.getItem( "prefstore" );
	COOKIE_NAME = window.localStorage.getItem( "cookie_name" );	
	DOMAIN = window.localStorage.getItem( "domain" );	
	
	//-- Setup the global variables for the page
	var user_id;
	var user_name;
	
	//-- and startup the main function
	refresh( 300 );
	
	//-- Main function (also named refresh because it is called after 
	//-- any action has occurred in order to update the page view)	
	function refresh( duration ) {
		user_id = window.localStorage.getItem( "user_id" );
		user_name = window.localStorage.getItem( "user_name" );

		$( '#user_name' ).html( user_name ) 
		
		//-- create the appropriate information box
		if ( user_id && !user_name ) {
			displayBox( "registerBox", duration );
		}
		else if ( user_id && user_name ) {
			displayBox( "loggedInBox", duration );
		}
		else {
			chrome.browserAction.setIcon( { path:"icon-dormant.png" } );
			displayBox( "loggedOutBox", duration );
			$( '#loggedOutMsg' ).show( duration );
		}
		
		UpdateCurrentPageBox( duration );
	}


	/**
	 *
	 */
	function UpdateCurrentPageBox( duration ) {

		if (  user_id && user_name ) {

			pagesAnalysed = window.localStorage.getItem( "pagesAnalysed" );
			pagesSent = window.localStorage.getItem( "pagesSent" );
			pagesComplete = window.localStorage.getItem( "pagesComplete" );

			pagesSent = pagesSent ? pagesSent : 0;
			pagesComplete = pagesComplete ? pagesComplete : 0;
			pagesAnalysed = pagesAnalysed ? pagesAnalysed : 0;

			lastPage = eval( '(' + window.localStorage.getItem( "lastPage" ) + ')' );  
			lastPageStatus = window.localStorage.getItem( "lastPageStatus" );

			$( '#pagesAnalysed' ).html( "Pages distilled: " + pagesAnalysed );
			$( '#pagesSent' ).html( "Deliveries attempted: " + pagesSent );
			$( '#pagesComplete' ).html( "Deliveries completed: " + pagesComplete );
			
			$( '#termlist' ).html( "" );
			if ( lastPage ) {
				
				fvLength = 0;
				$.each( lastPage.fv, function( key, value ){ 
					fvLength++;
					$( '#termlist' ).append( 
						"<span class='blockTerm'><span class='blockNum'>" + value + "</span> " + key + " </span> &nbsp;"  
					);
				});
				
				$( '#pageTitle' ).html( "Page Title: " + unescape( lastPage.docName.substring( 0, 40 ) ) + "..." );
				$( '#pageStats' ).html( "Stats: " + lastPage.totalWords + " words / " + fvLength + " terms extracted" );
				$( '#pageStatus' ).html( "Status: <i>" + lastPageStatus + "</i>" ); 
			}
			else {
				$( '#pageTitle' ).html( "Page Title:" );
				$( '#pageStats' ).html( "Stats:" );
				$( '#pageStatus' ).html( "Status:" ); 
			}
			
			$( '#currentPageBox' ).show( duration );
		}
		else {
			$( '#currentPageBox' ).hide( duration );
		}
	}
	
	
	/**
	 * Function that hides or displays boxes depending on 
	 * the state of the model
	 */ 
	function displayBox( divToShow, duration ) {
		for( i = 0; i < DIV_NAMES.length; i++ ) {
			if ( divToShow == DIV_NAMES[ i ] ) {
				$( '#' + DIV_NAMES[ i ] ).show( duration );
			} 
			else {
				$( '#' + DIV_NAMES[ i ] ).hide( duration );
			}
		}
	}
	
	
	/**
	 * Function that redirects the user to the server's openid login
	 */ 
	function login( provider ) {
		window.open( PREFSTORE + "login?provider=" + provider, "_blank" )
	}
	
	
	/**
	 * Function that redirects the user to the server's openid login
	 */ 
	function logout( provider ) {

		chrome.cookies.remove({ "url" : DOMAIN, "name" : COOKIE_NAME }, function(info) {
				user_id = window.localStorage.removeItem( "user_id" );
				user_name = window.localStorage.removeItem( "user_name" );
				refresh(300);
			}
		);
	}
	
	
	/**
	 * Function that redirects the user to the server's account registration page
	 */ 
	function register( provider ) {
		window.open( PREFSTORE + "register", "_blank" )
	}
	
	
	/**
	 * Function that resets all of the extensions statistics
	 */
	function clearLocalStorage() {
		if ( confirm( 'Are you sure you want to clear Local Storage? This is not undoable...' ) ) {
			window.localStorage.setItem( "pagesAnalysed" ) = 0;
			window.localStorage.setItem( "pagesSent" ) = 0;
			window.localStorage.setItem( "pagesComplete" ) = 0;
			window.localStorage.setItem( "lastPage" ) = "{}";  
			window.localStorage.setItem( "lastPageStatus" ) = "";
			refresh( 300 );
		}
	}

	
</script>
</head>

<body onLoad="javascript:refresh()">
<div style="font-family:georgia; font-size:12px;">
	<div style="float:left; margin:-5 10 0 0; width:190px; text-align:right;"> 
		<img src="images/dwlogofull.png" style="border:1px; width:98%;"/>
		<span id="loggedOutMsg">Please login using one of:</span>
	</div>

	<div id="loggedOutBox" style="float:left; width:170px; margin-top:5px; margin-bottom:10px;" >
		<a id="google" class="openid_out" href="javascript:login('google')">	
			<img 
				onmouseover="google.className='openid_over'"
				onmouseout="google.className='openid_out'"
				src="images/google_openid.png" 
			/>
		</a>
		<a id="yahoo" class="openid_out" href="javascript:login('yahoo')">	
			<img 
				onmouseover="yahoo.className='openid_over'"
				onmouseout="yahoo.className='openid_out'"
				src="images/yahoo_openid.png" 
			/>
		</a>
		<a id="aol" class="openid_out" href="javascript:login('aol')">	
			<img 
				onmouseover="aol.className='openid_over'"
				onmouseout="aol.className='openid_out'"
				src="images/aol_openid.png" 
			/>
		</a>
		<a id="myopenid" class="openid_out" href="javascript:login('myopenid')">	
			<img 
				onmouseover="myopenid.className='openid_over'"
				onmouseout="myopenid.className='openid_out'"
			 	src="images/myopenid_openid.png" 
			 />
		</a>
	</div>

	<div id="loggedInBox" class="displayBox" style="height:65px; text-align:right; width:230px">
		<div style="font-size:19px; color: #444444; margin-bottom:-2px;">Username:</div>
		<div id="user_name" style="font-family:Georgia; font-size:14px; color: #444444;"></div>
		<div style="margin-top:0px;"><a href="javascript:logout()">logout</a></div>
	</div>

	<div id="registerBox" class="displayBox">
		Although you have authenticated via your open_id, 
		you still need to register a prefstore account.
		Please do so <a href="javascript:register()">here</a>.
	</div>
	<div class="currentPageDisplayBox" id="currentPageBox">
		<div class="day">User Stats:</div>
		<div id="pagesAnalysed" class="entry"></div>
		<div id="pagesSent" class="entry"></div>
		<div id="pagesComplete" class="entry"></div>
		<div class="entry"></div>

		<div class="day">Last Page Distilled:</div>
		<div id="pageTitle" class="entry"></div>
		<div id="pageStats" class="entry"></div>
		<div id="pageStatus" class="entry"></div>
		<div class="entry"></div>

		<div class="day">Extracted Terms:</div>
		<div id="termlist" class="entry" style="font-family:arial; line-height:220%'"></div>
		<div style="text-align:right; width:100%"> 
			<a href="javascript:clearLocalStorage()">reset stats</a>
		</div>
	</div>
</div>
</body>
</html>